# Continuous Integration - runs on Pull Requests only
# Validates changes before merging to main
name: CI

run-name: "CI: ${{ github.event.pull_request.title || github.head_ref }}"

on:
  pull_request:
    branches: ["main"]
    paths:
      - "_source/**"
      - "assets/**"
      - "scripts/**"
      - "assets.config.json"
      - "package.json"
      - ".github/workflows/**"

# Minimum permissions required
permissions:
  contents: read

# Cancel outdated PR runs (use head_ref for PR-specific grouping)
concurrency:
  group: ci-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # Build and validate using reusable workflow
  build:
    name: Validate
    uses: ./.github/workflows/build.yml
    with:
      upload-artifact: false

  # PR-specific: Check that build doesn't modify source files
  integrity:
    name: Source Integrity
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          lfs: true

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Build assets and verify source integrity
        run: |
          npm run build

          # Only check source files - ignore generated assets
          CHANGED_SOURCE=$(git status --porcelain | grep -E '^\s*M\s+(_source/|scripts/|assets\.config\.json|package\.json)' || true)
          if [ -n "$CHANGED_SOURCE" ]; then
            echo "❌ Build modified source files:"
            echo "$CHANGED_SOURCE"
            echo ""
            echo "This should not happen - build script may have a bug."
            exit 1
          fi
          echo "✅ Source files unchanged"

          # Info: Show regenerated assets (expected due to platform differences)
          CHANGED_ASSETS=$(git status --porcelain | grep -E '^\s*M\s+assets/' || true)
          if [ -n "$CHANGED_ASSETS" ]; then
            echo "ℹ️  Assets regenerated (expected due to platform differences):"
            echo "$CHANGED_ASSETS" | head -10
            ASSET_COUNT=$(echo "$CHANGED_ASSETS" | wc -l | tr -d ' ')
            if [ "$ASSET_COUNT" -gt 10 ]; then
              echo "... and $((ASSET_COUNT - 10)) more files"
            fi
          fi
